# 更新日志

## [未发布] - 2025-10-07

### 新增功能 🎉

#### 背景颜色配置
- 添加背景颜色选择器（默认白色 #ffffff）
- 背景颜色与背景图片可同时使用，形成分层效果
- 背景颜色填充整个画布，图片以contain模式覆盖其上

#### 文字阴影配置
- 添加文字阴影启用/禁用开关
- 可配置阴影颜色（默认黑色）
- 可调整模糊半径（0-50px，默认5px）
- 可调整X偏移（-50到50px，默认2px）
- 可调整Y偏移（-50到50px，默认2px）
- 显著提升复杂背景上的文字可读性

#### 比特率配置
- 新增视频比特率选择：5/10/20 Mbps
- 默认值：5 Mbps（标准质量）
- 10 Mbps：中等质量
- 20 Mbps：较好质量
- 支持用户根据需求平衡文件大小和视频质量

#### 倒计时格式重构
- 实现"经典格式"模式
- 新增"自动"显示选项：智能隐藏前导零
  - 例如：`1:30:05` 而不是 `01:30:05`
  - 当某个时间单位为0且为最高位时自动隐藏
- 保留其他三种选项：隐藏、显示、两位数字
- 更符合用户直觉的格式化逻辑

### 功能优化 ⚡

#### 视频导出系统重构
- **从WebM迁移到MP4格式**：
  - 使用VideoEncoder API (WebCodecs)替代MediaRecorder
  - 使用H.264编码替代VP9
  - 使用mp4-muxer创建标准MP4容器
  - 更好的兼容性和播放器支持

#### GPU资源管理优化
- **背压控制**：限制编码器队列大小≤5帧，避免内存溢出
- **定期让渡**：每100帧延迟50ms，防止GPU资源耗尽
- **质量编码模式**：latencyMode设置为'quality'
- **支持长视频**：成功测试600秒以上视频导出
- 显著降低导出长视频时的崩溃率

#### 帧率调整
- 调整默认帧率从30fps到**12fps**
- 新增6fps选项（超低帧率，文件极小）
- 移除60fps选项
- 帧率选项：6/12/24/30 FPS
- 平衡流畅度和文件大小

#### 渲染性能优化
- **图片缓存**：使用useRef缓存已加载的背景图片
- **避免重复加载**：配置变化时不重新加载图片
- **消除预览闪烁**：图片只在路径变化时重新加载
- **背景渲染优化**：先填充背景色，再绘制图片

#### 字体渲染修复
- **自动清理引号**：移除字体名称中的单引号和双引号
- 使用正则表达式 `/["']/g` 清理
- 避免某些字体名称导致的渲染错误

### UI/UX改进 🎨

#### 样式紧凑化
- 减少全局内边距：20px → 16px
- 减少配置区块间距：30px → 20px
- 减少配置项间距：15px → 10px
- 调整字体大小：14px → 13px
- 调整标题大小：h2 24px → 20px，h3 18px → 15px
- 减小按钮和输入框尺寸
- 整体布局更紧凑，单屏显示更多内容

#### 布局优化
- **删除顶部标题**：移除"倒计时配置"冗余标题
- **底部按钮固定**：导出按钮固定在底部，不随内容滚动
- **Flexbox布局**：使用flex容器实现固定底部
- **时间选择器合并**：时/分/秒选择器合并到单行显示
- **样式文件分离**：所有样式从行内迁移到CSS文件

#### 新增CSS类
- `.config-content`：可滚动内容区域
- `.config-footer`：固定底部区域
- `.time-selectors-row`：时间选择器行内布局
- 专门的滚动条样式应用到内容区

### 文档更新 📚

#### 更新的文档
- **user-guide.md**：更新所有新功能说明
  - 文字阴影配置详解
  - 背景颜色和图片分层说明
  - 格式模式和自动选项说明
  - 比特率配置说明
  - 帧率调整说明
  - GPU优化和长视频导出说明

- **config-examples.md**：更新所有配置示例
  - 添加新的配置参数
  - 更新推荐值（fps: 12, bitrate: 5）
  - 添加文字阴影配置示例

- **quick-start.md**：更新快速入门指南
  - 更新默认配置值
  - 添加文字阴影使用说明
  - 更新导出设置说明
  - 更新帧率和比特率表格

- **troubleshooting.md**：更新故障排除
  - 更新GPU崩溃解决方案
  - 添加最新的优化说明
  - 更新推荐配置

- **technical.md**：更新技术文档
  - 更新视频导出实现细节
  - 添加GPU优化说明
  - 更新性能优化部分
  - 更新已知限制

- **README.md**：更新文档中心
  - 更新核心特性列表
  - 更新技术栈（VideoEncoder, mp4-muxer）

- **IMPLEMENTATION_SUMMARY.md**：更新实现总结
  - 添加所有新功能
  - 更新实现位置
  - 标注优化和重构

### 默认值调整 🔧
- 字体颜色：白色 (#ffffff) → **黑色 (#000000)**
- 背景颜色：无 → **白色 (#ffffff)**
- 帧率：30 FPS → **12 FPS**
- 比特率：无 → **5 Mbps**
- 时间格式：无auto选项 → 增加 **auto（自动）** 选项

### 技术债务清理 🧹
- 弃用mp4-muxer的旧API，使用新API
- 从MediaRecorder迁移到VideoEncoder
- 样式从行内迁移到CSS文件
- 优化组件结构和状态管理

### 修复的Bug 🐛
1. **背景颜色被背景图片覆盖**
   - 修改渲染顺序：先填充颜色，再绘制图片
   - 确保contain模式未覆盖区域显示背景色

2. **字体名称包含引号导致渲染错误**
   - 添加字体名称清理逻辑
   - 使用正则表达式移除引号

3. **配置变化时预览闪烁**
   - 实现图片缓存机制
   - 只在图片路径变化时重新加载

4. **导出长视频时GPU崩溃**
   - 实现背压控制
   - 添加定期让渡机制
   - 优化编码器配置

---

## 版本历史

### v1.0.0 (2025-10-02)
- 首次发布
- 基础倒计时功能
- 字体、格式、位置配置
- 背景图片支持
- WebM视频导出

---

## 计划中的功能 🚀

### 短期计划
- [ ] 配置预设保存和加载
- [ ] 批量导出功能
- [ ] 更多格式模式（除了经典格式）
- [ ] 导出进度百分比显示

### 长期计划
- [ ] 音频支持（背景音乐、音效）
- [ ] 动画效果（渐变、缩放等）
- [ ] 粒子效果
- [ ] 多语言支持
- [ ] 云端配置同步

---

## 贡献者 👥
感谢所有为项目做出贡献的开发者！

## 许可证 📄
MIT License
