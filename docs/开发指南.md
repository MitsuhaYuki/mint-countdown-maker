# å€’è®¡æ—¶è§†é¢‘ç”Ÿæˆå™¨ - å¼€å‘æŒ‡å—

> é¢å‘å¼€å‘è€…çš„æŠ€æœ¯æ–‡æ¡£

## ğŸ“– ç›®å½•

- [å¼€å‘ç¯å¢ƒ](#å¼€å‘ç¯å¢ƒ)
- [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„)
- [æ ¸å¿ƒæŠ€æœ¯](#æ ¸å¿ƒæŠ€æœ¯)
- [å¼€å‘æµç¨‹](#å¼€å‘æµç¨‹)
- [æ„å»ºå‘å¸ƒ](#æ„å»ºå‘å¸ƒ)
- [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘)

---

## å¼€å‘ç¯å¢ƒ

### ç³»ç»Ÿè¦æ±‚
- Node.js 16+
- npm æˆ– yarn
- Git

### å¿«é€Ÿå¼€å§‹

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd mint-countdown-maker

# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

### æ¨èå·¥å…·
- **VSCode** - ä»£ç ç¼–è¾‘å™¨
- **ESLint** - ä»£ç æ£€æŸ¥
- **React DevTools** - React è°ƒè¯•

---

## é¡¹ç›®æ¶æ„

### æŠ€æœ¯æ ˆ
- **Electron 38** - æ¡Œé¢åº”ç”¨æ¡†æ¶
- **React 19** - UI æ¡†æ¶
- **Vite 7** - æ„å»ºå·¥å…·
- **Canvas API** - å›¾å½¢æ¸²æŸ“
- **WebCodecs API** - è§†é¢‘ç¼–ç 

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ main/                   # Electron ä¸»è¿›ç¨‹
â”‚   â””â”€â”€ index.js           # IPC å¤„ç†ã€ç³»ç»Ÿ API
â”œâ”€â”€ preload/               # é¢„åŠ è½½è„šæœ¬
â”‚   â””â”€â”€ index.js           # å®‰å…¨çš„ IPC æ¡¥æ¥
â””â”€â”€ renderer/              # React æ¸²æŸ“è¿›ç¨‹
    â””â”€â”€ src/
        â”œâ”€â”€ App.jsx                    # ä¸»åº”ç”¨é€»è¾‘
        â”œâ”€â”€ components/
        â”‚   â”œâ”€â”€ CountdownPreview.jsx   # é¢„è§ˆç»„ä»¶
        â”‚   â””â”€â”€ CountdownConfig.jsx    # é…ç½®ç»„ä»¶
        â””â”€â”€ utils/
            â”œâ”€â”€ videoExporter.js       # è§†é¢‘å¯¼å‡º
            â””â”€â”€ configHelp.js          # é…ç½®å¸®åŠ©æ–‡æœ¬
```

### è¿›ç¨‹é€šä¿¡ (IPC)

**ä¸»è¿›ç¨‹ API** (`main/index.js`)ï¼š
```javascript
// è·å–ç³»ç»Ÿå­—ä½“
ipcMain.handle('get-system-fonts', async () => {
  const fonts = await fontList.getFonts()
  return fonts
})

// é€‰æ‹©èƒŒæ™¯å›¾ç‰‡
ipcMain.handle('select-background-image', async () => {
  const result = await dialog.showOpenDialog({
    properties: ['openFile'],
    filters: [{ name: 'Images', extensions: ['jpg', 'png', 'gif'] }]
  })
  // è¿”å› base64 å›¾ç‰‡æ•°æ®
})

// ä¿å­˜è§†é¢‘æ–‡ä»¶
ipcMain.handle('save-video-file', async (event, filePath, buffer) => {
  await fs.promises.writeFile(filePath, buffer)
  return { success: true }
})
```

**é¢„åŠ è½½è„šæœ¬** (`preload/index.js`)ï¼š
```javascript
const api = {
  getSystemFonts: () => ipcRenderer.invoke('get-system-fonts'),
  selectBackgroundImage: () => ipcRenderer.invoke('select-background-image'),
  saveVideoDialog: () => ipcRenderer.invoke('save-video-dialog'),
  saveVideoFile: (filePath, buffer) => 
    ipcRenderer.invoke('save-video-file', filePath, buffer)
}

contextBridge.exposeInMainWorld('api', api)
```

**æ¸²æŸ“è¿›ç¨‹è°ƒç”¨**ï¼š
```javascript
const fonts = await window.api.getSystemFonts()
const imageData = await window.api.selectBackgroundImage()
```

---

## æ ¸å¿ƒæŠ€æœ¯

### 1. Canvas æ¸²æŸ“

**å®æ—¶é¢„è§ˆ** (`CountdownPreview.jsx`)ï¼š

```javascript
useEffect(() => {
  const canvas = canvasRef.current
  const ctx = canvas.getContext('2d')
  
  // 1. ç»˜åˆ¶èƒŒæ™¯
  ctx.fillStyle = config.backgroundColor
  ctx.fillRect(0, 0, canvas.width, canvas.height)
  
  // 2. ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡
  if (backgroundImage) {
    const size = config.backgroundSize || 'cover'
    // è®¡ç®—ç¼©æ”¾å’Œä½ç½®
    ctx.drawImage(img, x, y, drawWidth, drawHeight)
  }
  
  // 3. åº”ç”¨æ··åˆæ¨¡å¼
  if (config.blendMode !== 'none') {
    ctx.globalCompositeOperation = config.blendMode
  }
  
  // 4. ç»˜åˆ¶æ–‡å­—
  ctx.font = `${config.fontSize}px "${config.fontFamily}"`
  ctx.fillStyle = config.fontColor
  
  // åº”ç”¨é˜´å½±
  if (config.textShadowEnabled) {
    ctx.shadowColor = config.textShadowColor
    ctx.shadowBlur = config.textShadowBlur
    ctx.shadowOffsetX = config.textShadowOffsetX
    ctx.shadowOffsetY = config.textShadowOffsetY
  }
  
  ctx.fillText(text, posX, posY)
  
  // é‡ç½®æ··åˆæ¨¡å¼
  ctx.globalCompositeOperation = 'source-over'
}, [config, countdown])
```

### 2. è§†é¢‘å¯¼å‡º

**ä½¿ç”¨ WebCodecs API** (`App.jsx`)ï¼š

```javascript
import { VideoExporter } from './utils/videoExporter'

const handleExportVideo = async () => {
  const exporter = new VideoExporter(tempCanvas)
  
  // é…ç½®ç¼–ç å™¨
  await exporter.startRecording(config.fps, config.bitrate)
  
  // é€å¸§æ¸²æŸ“
  const totalFrames = config.totalSeconds * config.fps
  for (let frame = 0; frame < totalFrames; frame++) {
    const currentSecond = Math.floor(frame / config.fps)
    const remainingSeconds = config.totalSeconds - currentSecond
    
    // ç»˜åˆ¶èƒŒæ™¯å’Œæ–‡å­—
    drawBackground()
    drawCountdownText(remainingSeconds)
    
    // æ·»åŠ å¸§åˆ°ç¼–ç å™¨
    await exporter.addFrame()
    
    // GPU èµ„æºç®¡ç†
    if (frame % 100 === 0) {
      await new Promise(resolve => setTimeout(resolve, 50))
    }
  }
  
  // è·å–è§†é¢‘æ•°æ®
  const blob = await exporter.stopRecording()
  
  // ä¿å­˜æ–‡ä»¶
  const arrayBuffer = await blob.arrayBuffer()
  await window.api.saveVideoFile(filePath, new Uint8Array(arrayBuffer))
}
```

**VideoExporter ç±»** (`utils/videoExporter.js`)ï¼š

```javascript
export class VideoExporter {
  async startRecording(fps, bitrate) {
    const stream = this.canvas.captureStream(fps)
    const track = stream.getVideoTracks()[0]
    
    // é…ç½® H.264 ç¼–ç å™¨
    this.encoder = new VideoEncoder({
      output: (chunk, metadata) => {
        this.chunks.push(chunk)
      },
      error: (e) => console.error(e)
    })
    
    this.encoder.configure({
      codec: 'avc1.42E01E',
      width: this.canvas.width,
      height: this.canvas.height,
      bitrate: bitrate * 1000000,
      framerate: fps,
      latencyMode: 'quality'
    })
  }
  
  async stopRecording() {
    await this.encoder.flush()
    // ä½¿ç”¨ mp4-muxer æ‰“åŒ…ä¸º MP4
    return this.muxer.finalize()
  }
}
```

### 3. å€’è®¡æ—¶æ ¼å¼åŒ–

**ç»å…¸æ ¼å¼**ï¼š
```javascript
function formatCountdownText(countdown, config) {
  const { hours, minutes, seconds } = countdown
  const { hourFormat, minuteFormat, secondFormat, separator } = config
  
  const parts = []
  
  // å¤„ç†å°æ—¶
  if (hourFormat === 'auto') {
    if (hours > 0) parts.push(hours.toString())
  } else if (hourFormat === 'show') {
    parts.push(hours.toString())
  } else if (hourFormat === 'two-digits') {
    parts.push(hours.toString().padStart(2, '0'))
  }
  
  // åŒæ ·å¤„ç†åˆ†é’Ÿå’Œç§’
  // ...
  
  return parts.join(separator || ':')
}
```

**çº¯æ•°å­—æ ¼å¼**ï¼š
```javascript
if (config.formatMode === 'pure-number') {
  const totalSeconds = hours * 3600 + minutes * 60 + seconds
  return totalSeconds.toString()
}
```

### 4. èƒŒæ™¯å›¾ç‰‡å¤„ç†

**Cover æ¨¡å¼**ï¼š
```javascript
if (size === 'cover') {
  if (imgRatio > canvasRatio) {
    // å›¾ç‰‡æ›´å®½ï¼Œä»¥é«˜åº¦ä¸ºå‡†
    drawHeight = canvas.height
    drawWidth = canvas.height * imgRatio
    x = (canvas.width - drawWidth) / 2
    y = 0
  } else {
    // å›¾ç‰‡æ›´é«˜ï¼Œä»¥å®½åº¦ä¸ºå‡†
    drawWidth = canvas.width
    drawHeight = canvas.width / imgRatio
    x = 0
    y = (canvas.height - drawHeight) / 2
  }
}
```

**Contain æ¨¡å¼**ï¼š
```javascript
if (size === 'contain') {
  if (imgRatio > canvasRatio) {
    // å›¾ç‰‡æ›´å®½ï¼Œä»¥å®½åº¦ä¸ºå‡†
    drawWidth = canvas.width
    drawHeight = canvas.width / imgRatio
    x = 0
    y = (canvas.height - drawHeight) / 2
  } else {
    // å›¾ç‰‡æ›´é«˜ï¼Œä»¥é«˜åº¦ä¸ºå‡†
    drawHeight = canvas.height
    drawWidth = canvas.height * imgRatio
    x = (canvas.width - drawWidth) / 2
    y = 0
  }
}
```

### 5. é…ç½®å¸®åŠ©ç³»ç»Ÿ

**é›†ä¸­å¼ç®¡ç†** (`utils/configHelp.js`)ï¼š
```javascript
export const configHelp = {
  fontFamily: 'é€‰æ‹©ç³»ç»Ÿä¸­å·²å®‰è£…çš„å­—ä½“...',
  fontSize: 'è®¾ç½®å€’è®¡æ—¶æ–‡å­—çš„å¤§å°...',
  blendMode: 'æ··åˆæ¨¡å¼å¯ä»¥è®©æ–‡å­—æ ¹æ®èƒŒæ™¯è‡ªåŠ¨è°ƒæ•´é¢œè‰²...',
  backgroundSize: 'Coverä¼šå¡«æ»¡ç”»å¸ƒï¼ŒContainä¼šå®Œæ•´æ˜¾ç¤ºå›¾ç‰‡...',
  // ... 21 ä¸ªé…ç½®é¡¹
}
```

**åœ¨ç»„ä»¶ä¸­ä½¿ç”¨**ï¼š
```javascript
import { configHelp } from '../utils/configHelp'

<label title={configHelp.fontFamily}>å­—ä½“ï¼š</label>
```

---

## å¼€å‘æµç¨‹

### æ·»åŠ æ–°é…ç½®é¡¹

**æ­¥éª¤ 1ï¼šæ›´æ–°é…ç½®çŠ¶æ€** (`App.jsx`)
```javascript
const [config, setConfig] = useState({
  // ç°æœ‰é…ç½®...
  newOption: 'default-value'  // æ–°å¢
})
```

**æ­¥éª¤ 2ï¼šæ·»åŠ  UI æ§ä»¶** (`CountdownConfig.jsx`)
```javascript
<div className="config-item">
  <label title={configHelp.newOption}>æ–°é€‰é¡¹ï¼š</label>
  <select
    value={config.newOption}
    onChange={(e) => onConfigChange({ ...config, newOption: e.target.value })}
  >
    <option value="option1">é€‰é¡¹1</option>
    <option value="option2">é€‰é¡¹2</option>
  </select>
</div>
```

**æ­¥éª¤ 3ï¼šåº”ç”¨åˆ°æ¸²æŸ“** (`CountdownPreview.jsx`)
```javascript
// åœ¨ç»˜åˆ¶é€»è¾‘ä¸­ä½¿ç”¨æ–°é…ç½®
if (config.newOption === 'option1') {
  // ç‰¹å®šå¤„ç†
}
```

**æ­¥éª¤ 4ï¼šåº”ç”¨åˆ°å¯¼å‡º** (`App.jsx`)
```javascript
// åœ¨å¯¼å‡ºé€»è¾‘ä¸­åŒæ­¥å¤„ç†
```

**æ­¥éª¤ 5ï¼šæ·»åŠ å¸®åŠ©æ–‡æœ¬** (`utils/configHelp.js`)
```javascript
export const configHelp = {
  // ...
  newOption: 'è¿™æ˜¯æ–°é€‰é¡¹çš„è¯´æ˜...'
}
```

### è°ƒè¯•æŠ€å·§

**å¼€å¯å¼€å‘è€…å·¥å…·**ï¼š
```javascript
// æŒ‰ F12 æˆ–åœ¨ä»£ç ä¸­
mainWindow.webContents.openDevTools()
```

**æŸ¥çœ‹ä¸»è¿›ç¨‹æ—¥å¿—**ï¼š
- ç»ˆç«¯è¾“å‡º
- `console.log()` è¯­å¥

**Canvas è°ƒè¯•**ï¼š
```javascript
// å°†ä¸´æ—¶ canvas æ·»åŠ åˆ°é¡µé¢
document.body.appendChild(tempCanvas)
tempCanvas.style.cssText = 'position:fixed;top:0;left:0;z-index:9999'
```

**æ€§èƒ½åˆ†æ**ï¼š
```javascript
console.time('export')
// å¯¼å‡ºä»£ç 
console.timeEnd('export')
```

---

## æ„å»ºå‘å¸ƒ

### æ„å»ºå‘½ä»¤

```bash
# Windows
npm run build:win

# macOS
npm run build:mac

# Linux
npm run build:linux
```

### æ„å»ºé…ç½® (`electron-builder.yml`)

```yaml
appId: com.example.countdown-maker
productName: Countdown Maker
directories:
  output: release/${version}

win:
  target:
    - nsis
  icon: build/icon.ico

mac:
  target:
    - dmg
  icon: build/icon.icns
  category: public.app-category.video

linux:
  target:
    - AppImage
    - deb
  icon: build/icon.png
  category: Video
```

### ç‰ˆæœ¬å‘å¸ƒæµç¨‹

1. æ›´æ–° `package.json` ç‰ˆæœ¬å·
2. æ›´æ–° `docs/æ›´æ–°æ—¥å¿—.md`
3. æäº¤ä»£ç å¹¶æ‰“ tag
4. è¿è¡Œæ„å»ºå‘½ä»¤
5. ä¸Šä¼ å®‰è£…åŒ…åˆ° Releases

---

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°æ··åˆæ¨¡å¼

```javascript
// CountdownConfig.jsx
<select value={config.blendMode}>
  <option value="none">æ— </option>
  <option value="new-mode">æ–°æ¨¡å¼</option>
</select>

// CountdownPreview.jsx
ctx.globalCompositeOperation = config.blendMode
```

### æ”¯æŒæ–°è§†é¢‘æ ¼å¼

ä¿®æ”¹ `VideoExporter` ç±»ä¸­çš„ç¼–ç å™¨é…ç½®ï¼š
```javascript
this.encoder.configure({
  codec: 'vp09.00.10.08',  // VP9 ç¼–ç 
  // å…¶ä»–é…ç½®
})
```

### æ·»åŠ å›½é™…åŒ–æ”¯æŒ

åŸºäºç°æœ‰ `configHelp` æ¶æ„ï¼š
```javascript
// utils/i18n.js
const translations = {
  'zh-CN': configHelp,
  'en-US': configHelpEN
}

export function t(key) {
  return translations[currentLocale][key]
}

// ä½¿ç”¨
<label title={t('fontFamily')}>Font:</label>
```

### ä¼˜åŒ–æ€§èƒ½

**é•¿è§†é¢‘å¯¼å‡ºä¼˜åŒ–**ï¼š
```javascript
// æ¯ N å¸§è®©æ¸¡ GPU
if (frameCount % 100 === 0) {
  await new Promise(resolve => setTimeout(resolve, 50))
}

// é™åˆ¶ç¼–ç å™¨é˜Ÿåˆ—
while (encoder.encodeQueueSize > 5) {
  await new Promise(resolve => setTimeout(resolve, 10))
}
```

---

## ä»£ç è§„èŒƒ

### ESLint é…ç½®

é¡¹ç›®ä½¿ç”¨ ESLint è¿›è¡Œä»£ç æ£€æŸ¥ï¼š
```bash
npm run lint
```

### ç»„ä»¶è§„èŒƒ

- ä½¿ç”¨å‡½æ•°ç»„ä»¶å’Œ Hooks
- Props è§£æ„åœ¨å‡½æ•°å‚æ•°ä¸­
- ä½¿ç”¨ `useEffect` å¤„ç†å‰¯ä½œç”¨
- çŠ¶æ€æå‡åˆ°çˆ¶ç»„ä»¶

### å‘½åè§„èŒƒ

- ç»„ä»¶ï¼šPascalCaseï¼ˆ`CountdownPreview`ï¼‰
- å‡½æ•°ï¼šcamelCaseï¼ˆ`formatCountdownText`ï¼‰
- å¸¸é‡ï¼šUPPER_CASEï¼ˆ`MAX_DURATION`ï¼‰
- CSS ç±»ï¼škebab-caseï¼ˆ`config-item`ï¼‰

---

## æŠ€æœ¯é™åˆ¶

1. **è§†é¢‘æ ¼å¼**ï¼šä»…æ”¯æŒ MP4ï¼ˆH.264ï¼‰
2. **æµè§ˆå™¨è¦æ±‚**ï¼šéœ€æ”¯æŒ WebCodecs API
3. **GPU ä¾èµ–**ï¼šé•¿è§†é¢‘å¯¼å‡ºéœ€è¦è‰¯å¥½çš„ GPU æ”¯æŒ
4. **å­—ä½“æ¸²æŸ“**ï¼šä¾èµ–ç³»ç»Ÿå­—ä½“ï¼ŒCanvas æ¸²æŸ“å¯èƒ½ä¸ç³»ç»Ÿç•¥æœ‰å·®å¼‚

---

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

---

## ç›¸å…³èµ„æº

- [Electron æ–‡æ¡£](https://www.electronjs.org/docs)
- [React æ–‡æ¡£](https://react.dev/)
- [Canvas API](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [WebCodecs API](https://developer.mozilla.org/en-US/docs/Web/API/WebCodecs_API)

---

**ç¥å¼€å‘æ„‰å¿«ï¼** ğŸš€
